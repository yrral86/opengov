<h3>It's a map!</h3>
<b>Locations:</b><br />
<%= ul map.locations do |l|
    "Title: #{l.title}, Latitude: #{l.latitude}, Longitude: #{l.longitude} " +
    object_details_link(l)
end %>
<script src="http://maps.google.com/maps/api/js?sensor=false&v=3.2" type="text/javascript"></script>

<div id="map" style="width: 500px; height: 400px">
  <script type="text/javascript">

    var google_map = {
      geocoder: new google.maps.Geocoder(),
      addresses: ['424 Evans Street, Morgantown, WV 26505'],
      markers: [],
      address_count: 1,
      current_address: 0,
      init: function() {
        options = {
          center: google.maps.LatLng(80,70),
          zoom: 8,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        this.map = new google.maps.Map($('map'),options);
        this.map_addresses();
      },
      map_addresses: function () {
        if (this.current_address == 0) {
          this.clear_markers();
        }
        if (this.current_address < this.address_count) {
	  request = {address: this.addresses[this.current_address++]};
          this.geocoder.geocode(request, this.map_address);
	} else {
	  this.current_address = 0;
	}
      },
      map_address: function(result, status) {
        var options = {
	      position: result[0].geometry.location,
	      title: result[0].formatted_address
        };
	google_map.new_marker(options);
      },
      new_marker: function(options) {
	this.map.setCenter(options.position);
	options.map = this.map;
        var marker = new google.maps.Marker(options);
	this.markers[this.current_address - 1] = marker;
        this.map_addresses();
      },
      clear_markers: function () {
	for (var i = 0; i < this.address_count; i++) {
	  var marker = this.markers[i];
          if (marker) {
	    marker.setMap(null);
	  }
	}
      },
      add_address: function () {
        this.addresses[this.address_count++] = $('add_address').address.value;
        this.map_addresses();
      }
    }
    Event.observe(window, 'load',
      google_map.init.bindAsEventListener(google_map), false);
  </script>
</div>
<form id="add_address" action="javascript:google_map.add_address();">
  Address: <input type="text" name="address" /> <input type="submit" value="Add">
</form>
